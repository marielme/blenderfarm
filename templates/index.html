<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroFarm: Blender Renderfarm Server</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <div class="header-controls">
            <div class="brand-container">
                <!-- SVG Logo -->
                <svg class="app-logo" width="48" height="48" viewBox="0 0 48 48" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <rect width="48" height="48" rx="12" fill="#6366F1" />
                    <path d="M24 12L34.3923 18V30L24 36L13.6077 30V18L24 12Z" stroke="white" stroke-width="3"
                        stroke-linejoin="round" />
                    <path d="M24 12V24M24 24L34.3923 30M24 24L13.6077 30" stroke="white" stroke-width="3"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="13.5" cy="18" r="3.5" fill="#10B981" stroke="white" stroke-width="2" />
                    <circle cx="34.5" cy="18" r="3.5" fill="#10B981" stroke="white" stroke-width="2" />
                    <circle cx="24" cy="36" r="3.5" fill="#10B981" stroke="white" stroke-width="2" />
                </svg>
                <h1 class="app-title">MicroFarm for Blender</h1>
            </div>
        </div>

        <div class="dashboard-layout">

            <!-- Sidebar Column -->
            <aside class="sidebar">
                <div class="card" id="section-upload">
                    <h2>Upload Blend File</h2>
                    <form id="uploadForm">
                        <div class="form-group">
                            <label for="blendFile">Blend File</label>
                            <input type="file" id="blendFile" name="blend_file" accept=".blend" required>
                        </div>
                        <div class="form-group">
                            <label for="projectName">Project Name</label>
                            <input type="text" id="projectName" name="project_name"
                                placeholder="Project name (optional)">
                        </div>
                        <div class="form-group">
                            <label for="frameStart">Start Frame</label>
                            <input type="number" id="frameStart" name="frame_start" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="frameEnd">End Frame</label>
                            <input type="number" id="frameEnd" name="frame_end" value="100" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="frameStep">Frame Step</label>
                            <input type="number" id="frameStep" name="frame_step" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="frameChunkSize">Frames Per Client</label>
                            <input type="number" id="frameChunkSize" name="frame_chunk_size" value="10" min="1"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="camera">Render Camera</label>
                            <input type="text" id="camera" name="camera" value="Camera" placeholder="Camera name">
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" id="queueImmediately" name="queue_immediately" checked>
                            <label for="queueImmediately">Start Job Immediately</label>
                        </div>
                        <button type="submit" class="btn submit-button">Upload and Create Job</button>
                        <div id="uploadError" class="error-message mt-2" style="color: var(--danger-color);"></div>
                    </form>
                </div>

                <div class="card" id="section-clients">
                    <h2>Connected Clients</h2>
                    <div id="clientsGrid" class="client-grid">
                        <p class="text-muted">Loading clients...</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content Column -->
            <main class="main-content">

                <div class="header-controls">
                    <h2>Dashboard</h2>
                    <button id="refreshButton" class="btn secondary">Refresh Data</button>
                </div>

                <div class="section" id="section-active-jobs" style="display: none;">
                    <h2>Active Jobs</h2>
                    <div id="activeJobsGrid" class="job-grid">
                        <!-- Jobs will be inserted here -->
                    </div>
                </div>

                <div class="section" id="section-queued-jobs" style="display: none;">
                    <h2>Queued Jobs</h2>
                    <div id="queuedJobsGrid" class="job-grid">
                        <!-- Jobs will be inserted here -->
                    </div>
                </div>

                <div class="section" id="section-completed-jobs" style="display: none;">
                    <h2>
                        Completed Jobs
                        <button id="toggleCompletedJobs" class="btn secondary text-sm"
                            style="padding: 2px 8px; margin-left: 10px;">Hide</button>
                    </h2>
                    <div id="completedJobsGrid" class="job-grid">
                        <!-- Jobs will be inserted here -->
                    </div>
                </div>
            </main>

        </div>

    </div>

    <script>
        // Refresh data on page load and every 5 seconds
        document.addEventListener('DOMContentLoaded', function () {
            refreshData();
            setInterval(refreshData, 5000);

            // Initialize theme based on stored preference or system preference
            initializeTheme();

            // Add event listener for manual refresh
            document.getElementById('refreshButton').addEventListener('click', refreshData);

            // Add event listener for form submission
            document.getElementById('uploadForm').addEventListener('submit', function (e) {
                e.preventDefault();
                uploadBlendFile();
            });

            // Add event listener for theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Add event listener for completed jobs toggle
            document.getElementById('toggleCompletedJobs').addEventListener('click', function () {
                const grid = document.getElementById('completedJobsGrid');
                const isHidden = grid.style.display === 'none';
                grid.style.display = isHidden ? 'grid' : 'none';
                this.textContent = isHidden ? 'Hide' : 'Show';
            });
        });

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && systemDarkMode)) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeToggle(true);
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                updateThemeToggle(false);
            }

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        updateThemeToggle(true);
                    } else {
                        document.documentElement.setAttribute('data-theme', 'light');
                        updateThemeToggle(false);
                    }
                }
            });
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme === 'dark');
        }

        function updateThemeToggle(isDarkMode) {
            const themeToggle = document.getElementById('themeToggle');
            const iconSpan = themeToggle.querySelector('.icon');
            const textSpan = themeToggle.querySelector('span:not(.icon)');

            if (isDarkMode) {
                iconSpan.className = 'icon light-icon';
                textSpan.textContent = 'Light Mode';
            } else {
                iconSpan.className = 'icon dark-icon';
                textSpan.textContent = 'Dark Mode';
            }
        }

        // Track completed jobs to avoid unnecessary updates
        let lastCompletedJobsIds = new Set();

        function refreshData() {
            fetch('/api/status')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    updateClients(data.clients);
                    updateJobs(data.active_jobs, 'activeJobsGrid', 'section-active-jobs');
                    updateJobs(data.queued_jobs, 'queuedJobsGrid', 'section-queued-jobs');

                    // Only update completed jobs if the list has changed
                    const currentCompletedIds = new Set(data.completed_jobs.map(job => job.id));
                    const hasChanged = currentCompletedIds.size !== lastCompletedJobsIds.size ||
                        [...currentCompletedIds].some(id => !lastCompletedJobsIds.has(id));

                    if (hasChanged) {
                        updateJobs(data.completed_jobs, 'completedJobsGrid', 'section-completed-jobs');
                        lastCompletedJobsIds = currentCompletedIds;
                    }

                    document.querySelectorAll('#activeJobsGrid .job-preview img').forEach(img => {
                        if (img.src.includes('/latest_frame')) {
                            const src = img.src.split('?')[0];
                            img.src = `${src}?t=${new Date().getTime()}`;
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        function updateClients(clients) {
            const grid = document.getElementById('clientsGrid');
            if (!grid) return;

            if (!clients || clients.length === 0) {
                grid.innerHTML = '<p class="text-muted">No clients connected</p>';
                return;
            }

            // Create a map of existing client cards by name
            const existingCards = {};
            grid.querySelectorAll('.client-card').forEach(card => {
                const name = card.querySelector('h4')?.textContent;
                if (name) existingCards[name] = card;
            });

            // Track which clients we've seen
            const seenClients = new Set();

            clients.forEach(client => {
                const clientName = client.name || 'Unnamed Client';
                seenClients.add(clientName);

                const statusClass = `status-${client.status?.toLowerCase() || 'unknown'}`;
                const lastPing = client.last_ping ? new Date(client.last_ping).toLocaleString() : 'N/A';

                const newHtml = `
                    <h4>${clientName}</h4>
                    <p><strong>IP:</strong> ${client.ip || 'N/A'}</p>
                    <p><strong>Status:</strong> <span class="status-badge ${statusClass}">${client.status || 'Unknown'}</span></p>
                    <p><strong>Last Seen:</strong> ${lastPing}</p>
                    ${client.current_job_id ? `<p><strong>Job:</strong> ${client.current_job_id}</p>` : ''}
                    ${client.current_frames && client.current_frames.length > 0 ? `<p><strong>Frames:</strong> ${client.current_frames.join(', ')}</p>` : ''}
                `;

                if (existingCards[clientName]) {
                    // Update existing card only if content changed
                    if (existingCards[clientName].innerHTML.trim() !== newHtml.trim()) {
                        existingCards[clientName].innerHTML = newHtml;
                    }
                } else {
                    // Create new card
                    const newCard = document.createElement('div');
                    newCard.className = 'client-card';
                    newCard.innerHTML = newHtml;
                    grid.appendChild(newCard);
                    existingCards[clientName] = newCard;
                }
            });

            // Remove cards for clients that no longer exist
            Object.keys(existingCards).forEach(name => {
                if (!seenClients.has(name)) {
                    existingCards[name].remove();
                }
            });
        }

        function updateJobs(jobs, gridId, sectionId) {
            const grid = document.getElementById(gridId);
            const section = document.getElementById(sectionId);
            if (!grid || !section) return;

            if (!jobs || jobs.length === 0) {
                // Hide the entire section if there are no jobs
                section.style.display = 'none';
                grid.innerHTML = '';
                return;
            }

            // Show the section if there are jobs
            section.style.display = 'block';

            let html = '';
            jobs.forEach(job => {
                if (!job || !job.id) return;

                const displayStatus = (job.display_status || job.status)?.toLowerCase() || 'unknown';
                const statusClass = `status-${displayStatus}`;

                let statusLabel = displayStatus.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                if (displayStatus === "pending") statusLabel = "Pending Clients";
                else if (displayStatus === "restart") statusLabel = "Needs Restart";
                else if (displayStatus === "pending_restart") statusLabel = "Pending Restart";


                const startTime = job.start_time ? new Date(job.start_time).toLocaleString() : 'N/A';
                const endTime = job.end_time ? new Date(job.end_time).toLocaleString() : '';
                const progress = job.progress !== undefined ? job.progress : 0;

                let jobExtras = '';
                if (job.status === 'completed' || job.status === 'cancelled') {
                    const hasActivePreview = job.status === 'active' && job.completed_frames > 0;

                    // Download buttons at the top (if MP4 is ready)
                    let downloadButtons = '';
                    if (job.mp4_status === 'completed') {
                        downloadButtons = `
                            <div class="download-buttons" style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <a href="/api/jobs/${job.id}/mp4" target="_blank" class="btn" style="flex: 1; text-align: center; background-color: var(--success-color); color: white; text-decoration: none;">MP4</a>
                                <a href="/api/jobs/${job.id}/files" target="_blank" class="btn" style="flex: 1; text-align: center; background-color: var(--primary-color); color: white; text-decoration: none;">Images</a>
                            </div>
                        `;
                    }

                    // MP4 creation controls
                    let mp4Controls = `
                        <div class="mp4-controls" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                            <h5>Create MP4 Video</h5>
                            <div class="form-group">
                                <select id="codec-${job.id}" class="mp4-select">
                                    <option value="h264">H.264 (Default)</option>
                                    <option value="hevc">H.265/HEVC</option>
                                    <option value="prores">ProRes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="quality-${job.id}" class="mp4-select">
                                    <option value="medium">Medium Quality</option>
                                    <option value="high">High Quality</option>
                                    <option value="low">Low Quality</option>
                                </select>
                            </div>
                            <button onclick="createMp4('${job.id}')" class="btn create-mp4" style="width: 100%;">Create MP4</button>
                            <div id="mp4-status-${job.id}"></div>
                        </div>
                     `;

                    if (job.mp4_status) {
                        let statusClass = 'in-progress';
                        let statusText = 'Creating MP4...';

                        // Only show status for in-progress or failed states
                        if (job.mp4_status === 'failed') {
                            statusClass = 'error';
                            statusText = `Failed: ${job.mp4_error || 'Unknown error'}`;

                            mp4Controls += `
                                <div class="mp4-status ${statusClass}" style="margin-top: 10px; padding: 8px; border-radius: 4px; background-color: var(--danger-color); color: white;">
                                    ${statusText}
                                </div>
                             `;
                        } else if (job.mp4_status !== 'completed') {
                            // Show in-progress status
                            mp4Controls += `
                                <div class="mp4-status ${statusClass}" style="margin-top: 10px; padding: 8px; border-radius: 4px; background-color: var(--warning-color); color: white;">
                                    ${statusText}
                                </div>
                             `;
                        }
                    }

                    jobExtras = `
                        ${downloadButtons}
                        <p><strong>End:</strong> ${endTime}</p>
                        ${job.duration && job.duration !== 'N/A' ? `<p><strong>Duration:</strong> ${job.duration}</p>` : ''}
                        ${mp4Controls}
                        <button onclick="deleteJob('${job.id}')" class="btn delete-job" style="margin-top: 10px; width: 100%; background-color: var(--danger-color);">Delete Job</button>
                     `;
                } else {
                    jobExtras = `
                        <div class="job-controls" style="display: flex; justify-content: space-between; gap: 20px;">
                            ${job.status === 'active' ? `<button onclick="cancelJob('${job.id}')" class="btn danger">Cancel</button>` : ''}
                            ${job.status === 'queued' ? `<button onclick="cancelJob('${job.id}')" class="btn danger">Remove</button>` : ''}
                            ${job.status === 'active' ? `<button onclick="forceCompleteJob('${job.id}')" class="btn warning" style="margin-left: auto;">Force Complete</button>` : ''}
                        </div>
                    `;
                }

                let previewHtml = '';
                if (job.mp4_status === 'completed' && job.mp4_path) {
                    previewHtml = `
                        <div class="job-preview video-preview" onclick="window.open('/api/jobs/${job.id}/mp4', '_blank')">
                            <div class="video-container">
                                <video class="video-thumbnail" src="/api/jobs/${job.id}/mp4" muted loop onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>
                                <div class="play-button"></div>
                            </div>
                        </div>
                     `;
                } else if (job.completed_frames && job.completed_frames.length > 0) {
                    const randomFrame = job.completed_frames[job.completed_frames.length - 1];
                    previewHtml = `
                        <div class="job-preview" onclick="window.open('/api/jobs/${job.id}/latest_frame', '_blank')">
                            <div class="preview-badge">PREVIEW</div>
                            <img src="/api/jobs/${job.id}/latest_frame" alt="Latest Frame" loading="lazy">
                        </div>
                    `;
                } else if (job.status === 'active') {
                    previewHtml = `
                        <div class="job-preview" onclick="window.open('/api/jobs/${job.id}/latest_frame', '_blank')">
                            <img src="/api/jobs/${job.id}/latest_frame" alt="Latest Frame" loading="lazy" onerror="this.style.display='none'">
                        </div>
                    `;
                }

                html += `
                    <div class="job-card">
                        <div style="margin-bottom: 10px;">
                            <h4 style="margin: 0 0 5px 0; text-align: left;">${job.project_name || 'Untitled'}</h4>
                            <div style="text-align: right; font-size: 0.85em; color: var(--text-muted);">#${job.id}</div>
                        </div>
                        <p><strong>Status:</strong> <span class="status-badge ${statusClass}">${statusLabel}</span></p>
                        <p><strong>Progress:</strong> ${Math.round(progress)}% (${job.completed_frames || 0}/${job.total_frames || 0})</p>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <p><strong>Start:</strong> ${startTime}</p>
                        ${previewHtml}
                        <div style="margin-top: 15px;">
                            ${jobExtras}
                        </div>
                    </div>
                `;
            });

            // Only update if content has changed
            const newHtml = html.trim();
            const currentHtml = grid.innerHTML.trim();
            if (newHtml !== currentHtml) {
                grid.innerHTML = html;
            }
        }

        function uploadBlendFile() {
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);
            const errorDiv = document.getElementById('uploadError');
            const submitBtn = form.querySelector('button[type="submit"]');

            errorDiv.textContent = '';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        errorDiv.textContent = data.message;
                    } else {
                        form.reset();
                        refreshData();
                        alert('Job created successfully!');
                    }
                })
                .catch(error => {
                    errorDiv.textContent = 'Upload failed: ' + error.message;
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Upload and Create Job';
                });
        }

        function cancelJob(jobId) {
            if (!confirm('Are you sure you want to cancel and delete this job? This cannot be undone.')) return;

            // First cancel the job
            fetch(`/api/jobs/${jobId}/cancel`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok' || data.success === true) {
                        // Then delete it
                        return fetch(`/api/jobs/${jobId}/delete`, { method: 'POST' });
                    } else {
                        throw new Error(data.message || 'Failed to cancel job');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok' || data.success === true) {
                        refreshData();
                    } else {
                        alert('Job cancelled but failed to delete: ' + data.message);
                        refreshData(); // Still refresh to show cancelled state
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                    refreshData(); // Refresh to show current state
                });
        }

        function forceCompleteJob(jobId) {
            if (!confirm('Are you sure you want to force complete this job? This will stop rendering and treat current progress as final.')) return;

            fetch(`/api/jobs/${jobId}/force_complete`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok' || data.success === true) {
                        refreshData();
                    } else {
                        alert('Failed to force complete job: ' + data.message);
                    }
                })
                .catch(error => alert('Error: ' + error));
        }

        function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job and all its files? This cannot be undone.')) return;

            fetch(`/api/jobs/${jobId}/delete`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok' || data.success === true) {
                        refreshData();
                    } else {
                        alert('Failed to delete job: ' + data.message);
                    }
                })
                .catch(error => alert('Error: ' + error));
        }

        function createMp4(jobId) {
            const codec = document.getElementById(`codec-${jobId}`).value;
            const quality = document.getElementById(`quality-${jobId}`).value;

            const btn = document.querySelector(`#codec-${jobId}`).closest('.mp4-controls').querySelector('button');
            const originalText = btn.textContent;
            btn.textContent = 'Requesting...';
            btn.disabled = true;

            fetch(`/api/jobs/${jobId}/create_mp4`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    codec: codec,
                    quality: quality
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok' || data.success === true) {
                        refreshData();
                    } else {
                        alert('Failed to start MP4 creation: ' + data.message);
                    }
                })
                .catch(error => alert('Error: ' + error))
                .finally(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
        }
    </script>

    <footer
        style="position: fixed; bottom: 0; left: 0; right: 0; text-align: center; padding: 1rem; background-color: var(--card-bg); border-top: 1px solid var(--border-color); color: var(--text-muted); font-size: 0.875rem; z-index: 100;">
        <button id="themeToggle" class="theme-toggle btn secondary" style="margin-bottom: 0.5rem;">
            <span class="icon dark-icon"></span>
            <span>Toggle Theme</span>
        </button>
        <div>Created by Mariel Martinez Â©</div>
    </footer>
</body>

</html>
```