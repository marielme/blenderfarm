<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroFarm: Blender Renderfarm Server</title>
    <style>
        :root {
            /* Light mode (default) variables */
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --border-color: #ddd;
            --shadow-color: rgba(0,0,0,0.1);
            --card-bg: #fff;
            --section-bg: white;
            --input-bg: white;
            --input-color: #333;
            --input-border: #ddd;
            --sidebar-width: 340px; /* Define sidebar width */
            --layout-gap: 30px;
        }

        /* Dark mode variables */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a1a;
                --container-bg: #242424;
                --text-color: #e0e0e0;
                --border-color: #444;
                --shadow-color: rgba(0,0,0,0.3);
                --card-bg: #2d2d2d;
                --section-bg: #2d2d2d;
                --input-bg: #2d2d2d;
                --input-color: #e0e0e0;
                --input-border: #555;
            }
        }

        /* Dark mode class for manual toggle */
        html.dark-mode {
            --bg-color: #1a1a1a;
            --container-bg: #242424;
            --text-color: #e0e0e0;
            --border-color: #444;
            --shadow-color: rgba(0,0,0,0.3);
            --card-bg: #2d2d2d;
            --section-bg: #2d2d2d;
            --input-bg: #2d2d2d;
            --input-color: #e0e0e0;
            --input-border: #555;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1600px; /* Wider max-width for dashboard */
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px var(--shadow-color);
        }
        h1, h2, h3 {
            color: var(--text-color);
        }

        /* NEW: Dashboard Layout */
        .dashboard-layout {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr; /* Sidebar and Main Content */
            gap: var(--layout-gap);
            margin-top: 20px; /* Add some space below title */
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: var(--layout-gap); /* Space between sections in sidebar */
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: var(--layout-gap); /* Space between sections in main content */
        }

        .section {
           /* Removed margin-bottom, using gap in parent */
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--section-bg);
        }
        .job-grid, .client-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .job-card, .client-card {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            background-color: var(--card-bg);
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        .job-card h4, .client-card h4 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .progress-bar {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 3px;
            height: 10px;
            margin: 10px 0;
        }
        .progress-value {
            height: 100%;
            background-color: #4caf50;
            border-radius: 3px;
        }
        .job-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        button {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            background-color: #4caf50;
            color: white;
            cursor: pointer;
        }
        button.cancel {
            background-color: #f44336;
        }
        button.complete {
            background-color: #2196f3;
        }
        button.activate {
            background-color: #ff9800;
        }
        button:hover {
            opacity: 0.8;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--input-color);
        }
        .form-check {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-check input {
            width: auto;
        }
        .submit-button {
            background-color: #4caf50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
        .client-status {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 3px;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-idle {
            background-color: #9e9e9e;
        }
        .status-assigned {
            background-color: #ffa000;
        }
        .status-rendering {
            background-color: #4caf50;
        }
        .status-error {
            background-color: #f44336;
        }
        .refresh-button {
            background-color: #2196f3;
            padding: 10px 15px;
            /* margin-bottom: 20px; Removed, positioning handled differently */
        }
        .job-status {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 3px;
            color: white;
            font-size: 0.8em;
        }
        .status-active {
            background-color: #4caf50;
        }
        .status-queued {
            background-color: #ff9800;
        }
        .status-pending {
            background-color: #9c27b0; /* Purple for pending */
        }
        .status-restart {
            background-color: #e91e63; /* Pink for restart needed */
        }
        .status-completed {
            background-color: #2196f3;
        }
        .status-cancelled {
            background-color: #f44336;
        }

        /* MP4 Controls Styles */
        .mp4-controls {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color); /* Use variable */
        }
        .mp4-select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid var(--input-border); /* Use variable */
            background-color: var(--input-bg); /* Use variable */
            color: var(--input-color); /* Use variable */
            width: 100%;
            box-sizing: border-box;
        }
        .create-mp4 {
            background-color: #673ab7; /* Purple for MP4 */
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
        }
        .mp4-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .mp4-status.in-progress {
            background-color: #ffeb3b; /* Yellow */
            color: #333;
        }
        .mp4-status.success {
            background-color: #4caf50; /* Green */
            color: white;
        }
        .mp4-status.error {
            background-color: #f44336; /* Red */
            color: white;
        }
        .mp4-status.warning {
            background-color: #ff9800; /* Orange */
            color: white;
        }

        /* Toggle button and preview styles */
        .toggle-button {
            font-size: 0.8em;
            padding: 3px 8px;
            margin-left: 10px;
            background-color: #607d8b;
            vertical-align: middle;
        }
        .job-preview {
            margin-top: 10px;
            text-align: center;
        }
        .job-preview img, .job-preview video {
            max-width: 100%;
            max-height: 150px;
            border: 1px solid var(--border-color); /* Use variable */
            border-radius: 3px;
            cursor: pointer;
            background-color: #000;
        }
        .delete-job {
            background-color: #f44336;
            margin-top: 10px;
            width: 100%;
        }
        .job-links {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        .job-links a {
            flex: 1;
            text-align: center;
            background-color: #2196f3;
            color: white;
            text-decoration: none;
            padding: 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .job-links a:hover {
            opacity: 0.9;
        }
        .job-preview {
            position: relative;
        }
        .video-preview {
            border: 2px solid #673ab7 !important;  /* Purple border for video previews */
        }
        .video-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #673ab7;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 150px;
            background-color: #000;
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }
        .video-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background-color: rgba(103, 58, 183, 0.7);
            border-radius: 50%;
        }
        .play-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 54%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-left: 15px solid white;
        }

        /* Dark mode toggle button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 20px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
        }

        .theme-toggle .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        /* Sun icon for dark mode toggle */
        .light-icon {
            background: radial-gradient(circle, transparent 50%, #f1c40f 50%);
            position: relative;
        }

        .light-icon::after {
            content: '';
            position: absolute;
            top: -4px;
            left: 7px;
            width: 2px;
            height: 24px;
            background: #f1c40f;
            box-shadow: 0 0 0 0 #f1c40f;
            transform-origin: center;
        }

        .light-icon::before {
            content: '';
            position: absolute;
            top: 7px;
            left: -4px;
            width: 24px;
            height: 2px;
            background: #f1c40f;
            box-shadow: 0 0 0 0 #f1c40f;
            transform-origin: center;
        }

        /* Moon icon for light mode toggle */
        .dark-icon {
            border-radius: 50%;
            box-shadow: inset -3px 2px 0 0 #ddd;
            transform: rotate(-35deg);
            background: transparent;
            border: none;
        }

        /* NEW: Header Controls Styling */
        .header-controls {
            display: flex;
            justify-content: space-between; /* Pushes refresh button to the right */
            align-items: center;
            margin-bottom: 15px; /* Space below controls */
            /* Add padding/margin if needed */
        }


        /* NEW: Responsive Adjustments */
        @media (max-width: 992px) { /* Adjust breakpoint as needed */
            .dashboard-layout {
                grid-template-columns: 1fr; /* Stack columns */
            }
             :root {
                --sidebar-width: 100%; /* Not needed in single column */
            }
        }

         @media (max-width: 768px) { /* Adjust breakpoint as needed */
            .job-grid, .client-grid {
                 grid-template-columns: 1fr; /* Single column cards on smaller screens */
             }
             h1 {
                 font-size: 1.8em; /* Slightly smaller title */
             }
             .container {
                 padding: 15px;
             }
             .theme-toggle {
                 top: 15px;
                 right: 15px;
                 padding: 6px 10px;
                 font-size: 12px;
             }
             .theme-toggle .icon {
                 width: 14px;
                 height: 14px;
             }
         }


    </style>
</head>
<body>
    <div class="container">
        <!-- Title and Theme Toggle remain outside the main layout grid -->
        <h1>MicroFarm: Blender Render Farm Server</h1>
        <button id="themeToggle" class="theme-toggle">
            <span class="icon dark-icon"></span>
            <span>Toggle Theme</span>
        </button>

        <!-- NEW: Dashboard Layout Wrapper -->
        <div class="dashboard-layout">

            <!-- NEW: Sidebar Column -->
            <aside class="sidebar">
                <div class="section" id="section-upload">
                    <h2>Upload Blend File</h2>
                    <form id="uploadForm">
                        <div class="form-group">
                            <label for="blendFile">Blend File</label>
                            <input type="file" id="blendFile" name="blend_file" accept=".blend" required>
                        </div>
                        <div class="form-group">
                            <label for="projectName">Project Name</label>
                            <input type="text" id="projectName" name="project_name" placeholder="Project name (optional)">
                        </div>
                        <div class="form-group">
                            <label for="frameStart">Start Frame</label>
                            <input type="number" id="frameStart" name="frame_start" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="frameEnd">End Frame</label>
                            <input type="number" id="frameEnd" name="frame_end" value="100" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="frameStep">Frame Step</label>
                            <input type="number" id="frameStep" name="frame_step" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="frameChunkSize">Frames Per Client (Chunks)</label>
                            <input type="number" id="frameChunkSize" name="frame_chunk_size" value="10" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="camera">Render Camera</label>
                            <input type="text" id="camera" name="camera" value="Camera" placeholder="Camera name (default: Scene Default)">
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" id="queueImmediately" name="queue_immediately" checked>
                            <label for="queueImmediately">Start Job Immediately</label>
                        </div>
                        <button type="submit" class="submit-button">Upload and Create Job</button>
                        <div id="uploadError" class="error-message"></div>
                    </form>
                </div>

                <div class="section" id="section-clients">
                    <h2>Connected Clients</h2>
                    <div id="clientsGrid" class="client-grid">
                        <p>Loading clients...</p>
                    </div>
                </div>
            </aside>

            <!-- NEW: Main Content Column -->
            <main class="main-content">

                 <!-- NEW: Header Controls within Main Content -->
                 <div class="header-controls">
                     <h2>Job Status</h2> <!-- Maybe a general title for this area -->
                     <button id="refreshButton" class="refresh-button">Refresh Data</button>
                 </div>

                <div class="section" id="section-active-jobs">
                    <h2>Active Jobs</h2>
                    <div id="activeJobsGrid" class="job-grid">
                        <p>Loading jobs...</p>
                    </div>
                </div>

                <div class="section" id="section-queued-jobs">
                    <h2>Queued Jobs</h2>
                    <div id="queuedJobsGrid" class="job-grid">
                        <p>Loading queued jobs...</p>
                    </div>
                </div>

                <div class="section" id="section-completed-jobs">
                    <h2>Completed Jobs <button id="toggleCompletedJobs" class="toggle-button">Hide</button></h2>
                    <div id="completedJobsGrid" class="job-grid">
                        <p>Loading completed jobs...</p>
                    </div>
                </div>
            </main>

        </div> <!-- End Dashboard Layout -->

    </div> <!-- End Container -->


    <script>
        // --- NO CHANGES TO JAVASCRIPT NEEDED FOR THIS LAYOUT REORGANIZATION ---
        // Refresh data on page load and every 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            setInterval(refreshData, 5000);

            // Initialize theme based on stored preference or system preference
            initializeTheme();

            // Add event listener for manual refresh
            document.getElementById('refreshButton').addEventListener('click', refreshData);

            // Add event listener for form submission
            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                uploadBlendFile();
            });

            // Add event listener for theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Add event listener for completed jobs toggle
            document.getElementById('toggleCompletedJobs').addEventListener('click', function() {
                const grid = document.getElementById('completedJobsGrid');
                const isHidden = grid.style.display === 'none';
                grid.style.display = isHidden ? 'grid' : 'none';
                this.textContent = isHidden ? 'Hide' : 'Show';
                // If showing, maybe refresh just in case? Optional.
                if (isHidden) { refreshData(); }
            });
        });

        // Function to initialize theme
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeToggle = document.getElementById('themeToggle');

            // If user has a saved preference, use that
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark-mode');
                updateThemeToggle(true);
            } else if (savedTheme === 'light') {
                document.documentElement.classList.remove('dark-mode');
                updateThemeToggle(false);
            } else if (systemDarkMode) {
                // Otherwise, use system preference
                document.documentElement.classList.add('dark-mode');
                updateThemeToggle(true);
            } else {
                 // Default to light if nothing else matches
                 updateThemeToggle(false);
            }

            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                // Only apply system changes if user hasn't set a preference
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        document.documentElement.classList.add('dark-mode');
                        updateThemeToggle(true);
                    } else {
                        document.documentElement.classList.remove('dark-mode');
                        updateThemeToggle(false);
                    }
                }
            });
        }

        // Function to toggle theme
        function toggleTheme() {
            const isDarkMode = document.documentElement.classList.toggle('dark-mode');
            updateThemeToggle(isDarkMode);
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        }

        // Function to update theme toggle button
        function updateThemeToggle(isDarkMode) {
            const themeToggle = document.getElementById('themeToggle');
            const iconSpan = themeToggle.querySelector('.icon');
            const textSpan = themeToggle.querySelector('span:not(.icon)');

            if (isDarkMode) {
                iconSpan.className = 'icon light-icon';
                textSpan.textContent = 'Light Mode';
            } else {
                iconSpan.className = 'icon dark-icon';
                textSpan.textContent = 'Dark Mode';
            }
        }

        // Function to refresh data
        function refreshData() {
            fetch('/api/status')
                .then(response => {
                     if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status}`);
                     }
                     return response.json();
                })
                .then(data => {
                    updateClients(data.clients);
                    updateJobs(data.active_jobs, 'activeJobsGrid');
                    updateJobs(data.queued_jobs, 'queuedJobsGrid');
                    // Only update completed if visible or first load
                    const completedGrid = document.getElementById('completedJobsGrid');
                     if (completedGrid.style.display !== 'none' || !completedGrid.innerHTML.includes('job-card')) {
                         updateJobs(data.completed_jobs, 'completedJobsGrid');
                     }
                })
                .catch(error => {
                     console.error('Error fetching data:', error);
                     // Optionally display an error to the user on the page
                     // Example: document.getElementById('someErrorDisplayArea').textContent = 'Failed to load data. Please try refreshing.';
                });
        }

        // Function to update clients display
        function updateClients(clients) {
            const grid = document.getElementById('clientsGrid');
             if (!grid) return; // Prevent errors if element doesn't exist

            if (!clients || clients.length === 0) {
                grid.innerHTML = '<p>No clients connected</p>';
                return;
            }

            let html = '';
            clients.forEach(client => {
                const statusClass = `status-${client.status?.toLowerCase() || 'unknown'}`; // Added safety for undefined status
                const lastPing = client.last_ping ? new Date(client.last_ping).toLocaleString() : 'N/A'; // Format date/time
                html += `
                    <div class="client-card">
                        <h4>${client.name || 'Unnamed Client'}</h4>
                        <p><strong>IP:</strong> ${client.ip || 'N/A'}</p>
                        <p><strong>Status:</strong> <span class="client-status ${statusClass}">${client.status || 'Unknown'}</span></p>
                        <p><strong>Last Seen:</strong> ${lastPing}</p>
                        ${client.current_job_id ? `<p><strong>Job:</strong> ${client.current_job_id}</p>` : ''}
                        ${client.current_frames && client.current_frames.length > 0 ? `<p><strong>Frames:</strong> ${client.current_frames.join(', ')}</p>` : ''}
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        // Function to update jobs display
        function updateJobs(jobs, gridId) {
            const grid = document.getElementById(gridId);
             if (!grid) return; // Prevent errors if element doesn't exist

            if (!jobs || jobs.length === 0) {
                grid.innerHTML = '<p>No jobs in this category</p>';
                return;
            }

            let html = '';
            jobs.forEach(job => {
                if (!job || !job.id) return; // Skip invalid job data

                const displayStatus = (job.display_status || job.status)?.toLowerCase() || 'unknown';
                const statusClass = `status-${displayStatus}`;

                let statusLabel = displayStatus.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()); // Nicer formatting
                if (displayStatus === "pending") statusLabel = "Pending Clients";
                else if (displayStatus === "restart") statusLabel = "Needs Restart";
                else if (displayStatus === "pending_restart") statusLabel = "Pending Restart";


                const startTime = job.start_time ? new Date(job.start_time).toLocaleString() : 'N/A';
                const endTime = job.end_time ? new Date(job.end_time).toLocaleString() : '';
                const progress = job.progress !== undefined ? job.progress : 0; // Default progress to 0 if undefined


                // Preview, links, and controls for completed/cancelled jobs
                let jobExtras = '';
                if (job.status === 'completed' || job.status === 'cancelled') {
                     let mp4Controls = `
                        <div class="mp4-controls">
                            <h5>Create MP4 Video</h5>
                            <div class="form-group">
                                <label for="codec-${job.id}">Codec:</label>
                                <select id="codec-${job.id}" class="mp4-select">
                                    <option value="h264">H.264 (Fast, Good Compatibility)</option>
                                    <option value="hevc">H.265/HEVC (Smaller File)</option>
                                    <option value="prores">ProRes (High Quality)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="quality-${job.id}">Quality:</label>
                                <select id="quality-${job.id}" class="mp4-select">
                                    <option value="high">High</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <button class="create-mp4" onclick="createMP4('${job.id}')">Create MP4</button>
                            <div id="mp4-status-${job.id}" class="mp4-status"></div>
                        </div>
                    `;

                    let previewHtml = '';
                     const previewUrl = `/api/jobs/${job.id}/preview`;
                     const thumbnailUrl = `/api/jobs/${job.id}/thumbnail`; // Assuming a separate thumbnail endpoint

                    if (job.mp4_created && job.mp4_path) {
                         // Use thumbnail for preview, link opens video/preview endpoint
                        previewHtml = `
                            <div class="job-preview">
                                <div class="video-container" onclick="openVideoPreview('${job.id}')" title="Click to view video">
                                    <img src="${thumbnailUrl}" alt="Video thumbnail" class="video-thumbnail" onerror="this.style.display='none'">  <!-- Hide if thumbnail fails -->
                                    <div class="play-button"></div>
                                    <div class="video-badge">VIDEO</div>
                                </div>
                            </div>
                        `;
                    } else {
                         // Image preview linking to full image
                        previewHtml = `
                            <div class="job-preview">
                                <a href="${previewUrl}" target="_blank">
                                    <img src="${previewUrl}" alt="Preview (First Frame)" title="Click to enlarge" onerror="this.style.display='none'"/> <!-- Hide if preview fails -->
                                </a>
                            </div>
                        `;
                    }

                    let linksHtml = `
                        <div class="job-links">
                            <a href="/api/jobs/${job.id}/files" target="_blank">View Files</a>
                            ${job.mp4_path ? `<a href="/api/jobs/${job.id}/mp4" target="_blank" download>Download MP4</a>` : ''}
                        </div>
                    `;

                    let deleteButton = `
                        <button class="delete-job" onclick="deleteJob('${job.id}')">Delete Job Data</button>
                    `;

                    jobExtras = previewHtml + mp4Controls + linksHtml + deleteButton;
                }

                html += `
                    <div class="job-card">
                        <h4>${job.project_name || `Job ${job.id.substring(0, 8)}`}</h4>
                        <p><strong>ID:</strong> ${job.id}</p>
                        <p><strong>Status:</strong> <span class="job-status ${statusClass}">${statusLabel}</span></p>
                        <p><strong>Frames:</strong> ${job.frame_range || 'N/A'}</p>
                        <p><strong>Progress:</strong> ${job.completed_frames !== undefined ? job.completed_frames : '?'}/${job.total_frames !== undefined ? job.total_frames : '?'}</p>
                        <div class="progress-bar">
                            <div class="progress-value" style="width: ${progress}%"></div>
                        </div>
                        <p><strong>Started:</strong> ${startTime}</p>
                        ${endTime ? `<p><strong>Ended:</strong> ${endTime}</p>` : ''}

                        <div class="job-controls">
                            ${(job.status === 'active' || displayStatus === 'pending') ? `
                                <button class="cancel" onclick="cancelJob('${job.id}')">Cancel</button>
                                <button class="complete" onclick="forceCompleteJob('${job.id}')">Force Complete</button>
                            ` : ''}
                            ${(job.status === 'queued' || displayStatus === 'pending_restart') ? `
                                <button class="activate" onclick="activateJob('${job.id}')">Activate</button>
                                <button class="cancel" onclick="cancelJob('${job.id}')">Cancel</button>
                            ` : ''}
                        </div>

                        ${jobExtras}
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        // Function to upload blend file
        function uploadBlendFile() {
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);
            const submitButton = form.querySelector('.submit-button');
            const uploadError = document.getElementById('uploadError');
            uploadError.textContent = ''; // Clear previous errors

            // Basic file validation
            const blendFile = document.getElementById('blendFile').files[0];
            if (!blendFile) {
                uploadError.textContent = 'Please select a .blend file.';
                return;
            }
             if (!blendFile.name.toLowerCase().endsWith('.blend')) {
                 uploadError.textContent = 'Selected file must be a .blend file.';
                 return;
             }

            // Frame range validation
            const frameStart = parseInt(document.getElementById('frameStart').value);
            const frameEnd = parseInt(document.getElementById('frameEnd').value);
            const frameStep = parseInt(document.getElementById('frameStep').value);
            const frameChunkSize = parseInt(document.getElementById('frameChunkSize').value);

            if (isNaN(frameStart) || isNaN(frameEnd) || isNaN(frameStep) || isNaN(frameChunkSize)) {
                 uploadError.textContent = 'Frame numbers, step, and chunk size must be valid numbers.';
                 return;
            }
            if (frameEnd < frameStart) {
                uploadError.textContent = 'End frame must be greater than or equal to start frame.';
                return;
            }
             if (frameStep < 1 || frameChunkSize < 1) {
                 uploadError.textContent = 'Frame step and chunk size must be at least 1.';
                 return;
             }

            // Get checkbox value (already handled by FormData if name attribute is set)
            // const queueImmediately = document.getElementById('queueImmediately').checked;
            // formData.set('queue_immediately', queueImmediately.toString()); // FormData handles checkboxes correctly

             // Disable button during upload
             submitButton.disabled = true;
             submitButton.textContent = 'Uploading...';

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                 if (!response.ok) {
                     // Try to get error message from response body
                     return response.json().then(errData => {
                         throw new Error(errData.error || `HTTP error! status: ${response.status}`);
                     }).catch(() => {
                          // If response is not JSON or error parsing JSON
                         throw new Error(`HTTP error! status: ${response.status}`);
                     });
                 }
                 return response.json();
            })
            .then(data => {
                if (data.error) { // Should be caught by the !response.ok check now, but keep for safety
                    uploadError.textContent = data.error;
                } else {
                    alert(`Job created successfully! Job ID: ${data.job_id}`);
                    form.reset(); // Reset form fields
                    refreshData(); // Refresh job lists immediately
                }
            })
            .catch(error => {
                console.error('Upload Error:', error);
                uploadError.textContent = `Upload failed: ${error.message}`;
            })
             .finally(() => {
                 // Re-enable button
                 submitButton.disabled = false;
                 submitButton.textContent = 'Upload and Create Job';
             });
        }

        // Function to perform job actions (generic helper)
        function performJobAction(jobId, action, confirmMessage) {
             if (confirmMessage && !confirm(confirmMessage)) {
                 return; // User cancelled
             }

            fetch(`/api/jobs/${jobId}/${action}`, {
                method: 'POST',
                 headers: {
                    'Content-Type': 'application/json' // Optional, depending on backend
                 }
                 // body: JSON.stringify({}), // Optional, if backend expects a body
            })
            .then(response => {
                 if (!response.ok) {
                     return response.json().then(errData => {
                         throw new Error(errData.error || `Action failed: ${response.status}`);
                     }).catch(() => {
                          throw new Error(`Action failed: ${response.status}`);
                     });
                 }
                 return response.json();
            })
            .then(data => {
                if (data.error) { // Should be caught above, but double check
                    alert(`Error performing action '${action}': ${data.error}`);
                } else {
                    console.log(`Job ${jobId} action '${action}' successful:`, data.message || 'OK');
                    refreshData(); // Refresh lists after successful action
                }
            })
            .catch(error => {
                console.error(`Error performing action '${action}' on job ${jobId}:`, error);
                alert(`Error performing action '${action}': ${error.message}`);
            });
        }


        // Specific action functions using the helper
        function cancelJob(jobId) {
            performJobAction(jobId, 'cancel', `Are you sure you want to cancel job ${jobId}?`);
        }

        function forceCompleteJob(jobId) {
            performJobAction(jobId, 'force_complete', `Are you sure you want to force-complete job ${jobId}? This marks it as done even if frames are missing.`);
        }

        function activateJob(jobId) {
            performJobAction(jobId, 'activate'); // No confirmation needed usually
        }

        function deleteJob(jobId) {
            performJobAction(jobId, 'delete', `Are you sure you want to DELETE job ${jobId}? This will remove all associated files and cannot be undone.`);
        }

        // Function to create MP4 video
        function createMP4(jobId) {
            const codec = document.getElementById(`codec-${jobId}`).value;
            const quality = document.getElementById(`quality-${jobId}`).value;
            const statusElement = document.getElementById(`mp4-status-${jobId}`);
             const createButton = statusElement.previousElementSibling; // Get the button element

             if (!statusElement || !createButton) {
                 console.error("Could not find MP4 status or button elements for job", jobId);
                 return;
             }

            statusElement.innerHTML = 'Starting MP4 creation...';
            statusElement.className = 'mp4-status in-progress';
             createButton.disabled = true; // Disable button while processing

            fetch(`/api/jobs/${jobId}/create_mp4`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ codec, quality })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                         throw new Error(errData.error || `Request failed: ${response.status}`);
                     }).catch(() => {
                          throw new Error(`Request failed: ${response.status}`);
                     });
                }
                 return response.json();
            })
            .then(data => {
                if (data.error) { // Should be caught above
                    statusElement.innerHTML = `Error: ${data.error}`;
                    statusElement.className = 'mp4-status error';
                     createButton.disabled = false; // Re-enable on error
                } else {
                    statusElement.innerHTML = data.message || 'MP4 creation process started...';
                    statusElement.className = 'mp4-status in-progress';
                    pollMP4Status(jobId); // Start polling
                     // Button remains disabled until polling finishes
                }
            })
            .catch(error => {
                console.error('Create MP4 Error:', error);
                statusElement.innerHTML = `Error initiating creation: ${error.message}`;
                statusElement.className = 'mp4-status error';
                 createButton.disabled = false; // Re-enable on error
            });
        }

        // Function to poll MP4 creation status
        let mp4PollIntervals = {}; // Store intervals per job ID
        function pollMP4Status(jobId) {
            const statusElement = document.getElementById(`mp4-status-${jobId}`);
             const createButton = statusElement?.previousElementSibling; // Get the button again

            // Clear existing interval for this job ID if any
            if (mp4PollIntervals[jobId]) {
                clearInterval(mp4PollIntervals[jobId]);
            }

            const pollStartTime = Date.now();
            const maxPollDuration = 5 * 60 * 1000; // 5 minutes timeout

            mp4PollIntervals[jobId] = setInterval(() => {
                 // Timeout check
                 if (Date.now() - pollStartTime > maxPollDuration) {
                     clearInterval(mp4PollIntervals[jobId]);
                     delete mp4PollIntervals[jobId];
                     if (statusElement) {
                         statusElement.innerHTML = 'MP4 status check timed out.';
                         statusElement.className = 'mp4-status warning';
                     }
                     if (createButton) createButton.disabled = false; // Re-enable button
                     return;
                 }

                fetch(`/api/jobs/${jobId}/mp4_status`)
                .then(response => {
                     if (!response.ok) {
                          return response.json().then(errData => {
                             throw new Error(errData.error || `Status check failed: ${response.status}`);
                          }).catch(() => {
                              throw new Error(`Status check failed: ${response.status}`);
                          });
                     }
                     return response.json();
                })
                .then(data => {
                     if (!statusElement) { // Element might be gone if user navigated away
                          clearInterval(mp4PollIntervals[jobId]);
                          delete mp4PollIntervals[jobId];
                          return;
                     }

                     let keepPolling = true;
                    if (data.error) {
                        statusElement.innerHTML = `Error checking status: ${data.error}`;
                        statusElement.className = 'mp4-status error';
                        keepPolling = false;
                    } else {
                         switch(data.status) {
                             case 'completed':
                                 statusElement.innerHTML = `MP4 creation complete!`; // Link added via refresh
                                 statusElement.className = 'mp4-status success';
                                 keepPolling = false;
                                 refreshData(); // Refresh to show download link etc.
                                 break;
                             case 'failed':
                                 statusElement.innerHTML = `MP4 creation failed: ${data.error || 'Unknown reason'}`;
                                 statusElement.className = 'mp4-status error';
                                 keepPolling = false;
                                 break;
                             case 'in_progress':
                                 statusElement.innerHTML = `MP4 creation in progress... (${data.progress || '?' }%)`;
                                 statusElement.className = 'mp4-status in-progress';
                                 break;
                             case 'pending':
                                 statusElement.innerHTML = 'MP4 creation pending...';
                                 statusElement.className = 'mp4-status in-progress'; // Or a specific pending style
                                 break;
                             default:
                                 statusElement.innerHTML = `Status: ${data.status}`;
                                 // Decide if this status is terminal or requires polling
                                 // keepPolling = !['unknown', 'other_terminal_state'].includes(data.status);
                         }
                    }

                     if (!keepPolling) {
                         clearInterval(mp4PollIntervals[jobId]);
                         delete mp4PollIntervals[jobId];
                         if (createButton) createButton.disabled = false; // Re-enable button
                     }
                })
                .catch(error => {
                    console.error('Error polling MP4 status:', error);
                     if (statusElement) {
                        statusElement.innerHTML = `Error checking status: ${error.message}`;
                        statusElement.className = 'mp4-status error';
                     }
                     clearInterval(mp4PollIntervals[jobId]);
                     delete mp4PollIntervals[jobId];
                     if (createButton) createButton.disabled = false; // Re-enable button
                });
            }, 3000); // Poll every 3 seconds
        }

        // Function to open video preview/download (decides based on endpoint behavior)
        function openVideoPreview(jobId) {
            // This endpoint should ideally stream the video or force download
            window.open(`/api/jobs/${jobId}/mp4`, '_blank');
            // Alternatively, if /preview shows the video: window.open(`/api/jobs/${jobId}/preview`, '_blank');
        }

    </script>

</body>
</html>